// scripts/issue-codex-autofix.js
// This script is intended to be run by GitHub Actions when an issue is opened.
// It reads the issue content, uses Codex (OpenAI API) to generate a code solution,
// applies the changes, commits to a new branch, and opens a pull request.

const { execSync } = require("child_process");
const fs = require("fs");
const path = require("path");

const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const GITHUB_TOKEN = process.env.GITHUB_TOKEN;
const GITHUB_REPOSITORY = process.env.GITHUB_REPOSITORY;
const GITHUB_EVENT_PATH = process.env.GITHUB_EVENT_PATH;

if (!OPENAI_API_KEY || !GITHUB_TOKEN) {
  console.error("Missing OPENAI_API_KEY or GITHUB_TOKEN in environment.");
  process.exit(1);
}

// 1. Read the issue event payload
const event = JSON.parse(fs.readFileSync(GITHUB_EVENT_PATH, "utf8"));
const issue = event.issue;
if (!issue) {
  console.error("No issue found in event payload.");
  process.exit(1);
}
const issueTitle = issue.title;
const issueBody = issue.body;
const issueNumber = issue.number;

// 2. Create a new branch for the fix
const branchName = `codex-autofix/issue-${issueNumber}-${Date.now()}`;
execSync(`git checkout -b ${branchName}`);

// 3. Use Codex to generate a code solution
// We'll use the @openai/codex CLI in auto-edit mode, similar to the slack-release-note workflow.
// The prompt will be the issue title and body.
const prompt = `Resolve the following GitHub issue in this codebase:\n\nTitle: ${issueTitle}\n\n${issueBody}\n\nMake all necessary code changes to resolve the issue. Make sure tests and prettier pass.`;
const codexCmd = [
  "npx",
  "@openai/codex",
  "-q",
  "-a",
  "auto-edit",
  `"${prompt}"`,
].join(" ");

console.log("Running Codex auto-edit...");
try {
  execSync(`export OPENAI_API_KEY="${OPENAI_API_KEY}" && ${codexCmd}`, {
    stdio: "inherit",
  });
} catch (err) {
  console.error("Codex auto-edit failed:", err);
  process.exit(1);
}

// 4. Commit the changes
execSync('git config user.name "github-actions[bot]"');
execSync(
  'git config user.email "github-actions[bot]@users.noreply.github.com"',
);
execSync("git add .");
execSync(`git commit -m "fix: resolve issue #${issueNumber} with Codex"`);

// 5. Push the branch
execSync(`git push origin ${branchName}`);

// 6. Open a pull request using GitHub CLI
const prTitle = `fix: resolve issue #${issueNumber} with Codex`;
const prBody = `This PR was automatically generated by Codex to resolve #${issueNumber}.\n\nIssue title: ${issueTitle}\n\n---\n\n${issueBody}`;
const prCreateOutput = execSync(
  `gh pr create --title "${prTitle}" --body "${prBody}" --head "${branchName}" --base "main" --repo "${GITHUB_REPOSITORY}" --json url`,
  { encoding: "utf-8" },
);
const prUrl = JSON.parse(prCreateOutput).url;

console.log("Pull request created successfully:", prUrl);

// 7. Comment on the original issue with a link to the PR
const issueComment = `:robot: A pull request has been opened to resolve this issue: [${prTitle}](${prUrl})`;
execSync(
  `gh issue comment ${issueNumber} --body "${issueComment}" --repo "${GITHUB_REPOSITORY}"`,
  { stdio: "inherit" },
);

console.log("Commented on the issue with PR link.");
