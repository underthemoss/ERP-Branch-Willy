name: Release Notes

on:
  push:
    branches:
      - main
permissions:
  contents: read

jobs:
  generate:
    # if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Create diff
        run: |
          git diff ${{ github.event.before }}..${{ github.sha }} > diff.patch

      - name: Install Codex
        run: npm i -g @openai/codex

      - name: Generate release notes with Codex
        run: |
          npx codex --quiet "Generate user facing release notes. Use slack compatible markdown format.  Ignore CI/CD, refactorings, and other dev tasks, ignoring means output nothing, no text, empty." < diff.patch > release_notes.txt

      - name: Check if release notes exist
        id: check_notes
        run: |
          if [ -s release_notes.txt ]; then
            echo "has_notes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_notes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Post to Slack
        if: steps.check_notes.outputs.has_notes == 'true'
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          NOTES=$(jq -Rs . < release_notes.txt)
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d '{"content": '"$NOTES"', "channel": "C0912S17B9B"}'
