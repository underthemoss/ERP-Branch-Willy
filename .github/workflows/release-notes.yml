name: Release Notes

on:
  push:
    branches:
      - main
permissions:
  contents: read

jobs:
  generate:
    # if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Create diff
        run: |
          git diff ${{ github.event.before }}..${{ github.sha }} > diff.patch

      - name: Install Codex
        run: npm i -g @openai/codex

      - name: Generate release notes with Codex
        run: |
          npx codex --quiet --approval-mode full-auto "Generate user facing release notes, be brief. Use slack compatible markdown format. Read the diff here diff.patch and write the release notes to release_notes.md"

 

      - name: Post to Slack
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          node -e "
            const https = require('https');
            const fs = require('fs');
            const url = process.env.SLACK_WEBHOOK;
            const content = fs.readFileSync('release_notes.md', 'utf8');
            const data = JSON.stringify({ content, channel: 'C0912S17B9B' });
            const req = https.request(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Content-Length': data.length }
            }, res => {
              res.on('data', d => process.stdout.write(d));
            });
            req.on('error', error => { console.error(error); process.exit(1); });
            req.write(data);
            req.end();
          "
