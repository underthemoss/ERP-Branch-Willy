name: Vercel Deploy

on:
  push:
    branches: [main]

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    outputs:
      deployment-url: ${{ steps.deploy.outputs.deployment-url }}
      deployment-id: ${{ steps.deploy.outputs.deployment-id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=$VERCEL_TOKEN

      - name: Build Project Artifacts
        run: vercel build --target=staging --token=$VERCEL_TOKEN

      - name: Deploy to Staging
        id: deploy
        run: |
          deployment_url=$(vercel deploy --prebuilt --target=staging --token=$VERCEL_TOKEN --no-wait)
          echo "deployment-url=$deployment_url" >> $GITHUB_OUTPUT

          # Get deployment ID from the URL
          deployment_id=$(echo "$deployment_url" | sed 's|https://||' | cut -d'.' -f1)
          echo "deployment-id=$deployment_id" >> $GITHUB_OUTPUT

          echo "### ðŸš€ Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** $deployment_url" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment ID:** $deployment_id" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Post Slack notification for staging
        if: success()
        run: |
          cat > slack_message.txt << EOF
          {
            "text": "âœ… Staging Deployment Successful",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "âœ… Staging Deployment Successful",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Environment:*\nStaging"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Deployed by:*\n${{ github.actor }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n${{ github.ref_name }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Commit:*\n\`${{ github.sha }}\`"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Deployment URL:*\n${{ steps.deploy.outputs.deployment-url }}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Deployment",
                      "emoji": true
                    },
                    "url": "${{ steps.deploy.outputs.deployment-url }}"
                  },
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "Approve Production",
                      "emoji": true
                    },
                    "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }
          EOF

          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data @slack_message.txt \
              ${{ secrets.SLACK_WEBHOOK }}
          fi

      - name: Post Slack notification on failure
        if: failure()
        run: |
          cat > slack_message.txt << EOF
          {
            "text": "âŒ Staging Deployment Failed",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "âŒ Staging Deployment Failed",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Environment:*\nStaging"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Failed by:*\n${{ github.actor }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n${{ github.ref_name }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Commit:*\n\`${{ github.sha }}\`"
                  }
                ]
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Workflow",
                      "emoji": true
                    },
                    "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }
          EOF

          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data @slack_message.txt \
              ${{ secrets.SLACK_WEBHOOK }}
          fi

  # NOTE prod happens automatically, we'll likely change this later when it's not a team of two..
  # Also environment deployments "requires reviewers" feature is only available on the Enterprise plan.
  promote-to-production:
    name: Promote to Production
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.promote.outputs.production-url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Promote Staging to Production
        id: promote
        run: |
          # Use the Vercel API to promote the staging deployment to production
          echo "Promoting deployment ${{ needs.deploy-staging.outputs.deployment-id }} to production..."

          # First, we need to alias the deployment to production
          production_url=$(vercel promote ${{ needs.deploy-staging.outputs.deployment-url }} --yes --token=$VERCEL_TOKEN --scope=$VERCEL_ORG_ID)

          echo "production-url=$production_url" >> $GITHUB_OUTPUT

          echo "### ðŸŽ‰ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** $production_url" >> $GITHUB_STEP_SUMMARY
          echo "**Promoted from:** ${{ needs.deploy-staging.outputs.deployment-url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Approved by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Create Git Tag for Production
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Create a production tag with timestamp
          PROD_TAG="prod-$(date +'%Y%m%d-%H%M%S')"
          git tag -a $PROD_TAG -m "Production deployment from ${{ github.sha }}"
          git push origin $PROD_TAG

          echo "Created production tag: $PROD_TAG"

      - name: Post Slack notification for production
        if: success()
        run: |
          cat > slack_message.txt << EOF
          {
            "text": "ðŸŽ‰ Production Deployment Successful",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "ðŸŽ‰ Production Deployment Successful",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Environment:*\nProduction"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Approved by:*\n${{ github.actor }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n${{ github.ref_name }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Commit:*\n\`${{ github.sha }}\`"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Production URL:*\n${{ steps.promote.outputs.production-url }}"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Promoted from Staging:*\n${{ needs.deploy-staging.outputs.deployment-url }}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Production",
                      "emoji": true
                    },
                    "style": "primary",
                    "url": "${{ steps.promote.outputs.production-url }}"
                  },
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Workflow",
                      "emoji": true
                    },
                    "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }
          EOF

          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data @slack_message.txt \
              ${{ secrets.SLACK_WEBHOOK }}
          fi

      - name: Post Slack notification on failure
        if: failure()
        run: |
          cat > slack_message.txt << EOF
          {
            "text": "âŒ Production Deployment Failed",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "âŒ Production Deployment Failed",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Environment:*\nProduction"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Failed by:*\n${{ github.actor }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n${{ github.ref_name }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Commit:*\n\`${{ github.sha }}\`"
                  }
                ]
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Workflow",
                      "emoji": true
                    },
                    "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }
          EOF

          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data @slack_message.txt \
              ${{ secrets.SLACK_WEBHOOK }}
          fi
