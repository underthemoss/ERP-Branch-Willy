name: Staging Screenshot Capture

on:
  workflow_dispatch:

jobs:
  capture-screenshot:
    name: Capture Staging Screenshots
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Setup MCP Server
        run: |
          # Install Playwright MCP server
          npm install -g @playwright/mcp@latest

          # Create screenshots directory
          mkdir -p screenshots

      - name: Run Claude with Playwright MCP
        id: claude-screenshot
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          anthropic_model: "claude-sonnet-4-20250805"
          github_token: ${{ secrets.GITHUB_TOKEN }}
          mode: agent
          mcp_config: |
            {
              "mcpServers": {
                "playwright": {
                  "command": "npx",
                  "args": ["@playwright/mcp@latest"],
                  "env": {
                    "PLAYWRIGHT_BROWSER": "chromium"
                  }
                }
              }
            }
          allowed_tools: |
            MCP:playwright:browser_navigate
            MCP:playwright:browser_resize
            MCP:playwright:browser_take_screenshot
            MCP:playwright:browser_close
            MCP:playwright:browser_install
            Bash(ls -la screenshots)
            Bash(pwd)
          custom_instructions: |
            You are tasked with capturing screenshots of the staging environment using the Playwright MCP server.

            The staging URL is: https://staging-erp.estrack.com/

            Please follow these steps:

            1. First, install the browser if needed using the browser_install tool
            2. Navigate to the staging URL using browser_navigate
            3. Take screenshots at different viewport sizes:
               - Desktop: 1920x1080 - save as screenshots/staging-desktop.png
               - Tablet: 768x1024 - save as screenshots/staging-tablet.png  
               - Mobile: 375x812 - save as screenshots/staging-mobile.png
            4. For each viewport:
               - Use browser_resize to set the viewport size
               - Use browser_take_screenshot to capture the screenshot with the appropriate filename
            5. Also capture a full-page screenshot at 1920x1080 as screenshots/staging-fullpage.png
            6. Close the browser when done using browser_close

            Make sure all screenshots are saved in the screenshots/ directory.
            Verify the screenshots were created successfully by listing the directory contents.

      - name: Upload Screenshots as Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: staging-screenshots-${{ github.run_number }}
          path: screenshots/
          retention-days: 30

      - name: Generate Screenshot Summary
        if: success()
        run: |
          echo "## ðŸ“¸ Staging Screenshots Captured" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Screenshots have been captured for the staging environment." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Staging URL:** https://staging-erp.estrack.com/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Captured Views:" >> $GITHUB_STEP_SUMMARY
          echo "- Desktop (1920x1080)" >> $GITHUB_STEP_SUMMARY
          echo "- Tablet (768x1024)" >> $GITHUB_STEP_SUMMARY
          echo "- Mobile (375x812)" >> $GITHUB_STEP_SUMMARY
          echo "- Full Page (1920x1080)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[Download Screenshots](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Handle Failure
        if: failure()
        run: |
          echo "## âŒ Screenshot Capture Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Failed to capture screenshots for the staging environment." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Error Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow Run: [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the workflow logs for more information." >> $GITHUB_STEP_SUMMARY
