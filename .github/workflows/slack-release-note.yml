name: Release Notes

on:
  push:
    branches:
      - main
permissions:
  contents: read

jobs:
  generate:
    # if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Generate release notes
        run: |
          # Install Claude Code CLI
          npm install -g @anthropic-ai/claude-code

          # Get the last commit details
          COMMIT_SHA=$(git rev-parse HEAD)
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
          COMMIT_BODY=$(git log -1 --pretty=format:"%b")

          # Set up API key
          export ANTHROPIC_API_KEY="${{ secrets.ANTHROPIC_API_KEY }}"

          # Generate release notes using Claude Code in non-interactive mode
          claude --print --dangerously-skip-permissions "Generate user facing release notes for the following commit:

          Commit: $COMMIT_SHA
          Author: $COMMIT_AUTHOR
          Message: $COMMIT_MESSAGE
          Body: $COMMIT_BODY

          Please format the release notes with these sections:
          - User facing changes
          - Other changes  
          - Author
          - Commit Link
          - Limerick

          Use simple plain text formatting with emojis.

          Formatting with Slack mrkdwn
          Use *bold*, _italic_, ~strikethrough~.
          Use `inline code` or triple backticks (```) for code blocks.
          Use > at the start of a line for blockquotes.
          Use - or 1. with a space for lists.
          Use <https://example.com|custom text> for links.
          Use <@U12345> to mention a user, <#C12345> for a channel.
          Do not use Markdown headers (# Heading) — Slack doesn’t support them.
          No tables, images, or advanced layouts — only text formatting.

          Include the author name: $COMMIT_AUTHOR
          Include a link to the commit: https://github.com/EquipmentShare/es-erp/commit/$COMMIT_SHA

          Be brief and clear in your descriptions." > release_note.txt

          # Display the generated notes for debugging
          echo "Generated release notes:"
          cat release_note.txt

      - name: Post to Slack
        if: true
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          cat release_note.txt | node ./scripts/notify-slack.js
