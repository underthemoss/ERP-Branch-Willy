name: Release Notes

on:
  push:
    branches:
      - main
permissions:
  contents: read

jobs:
  generate:
    # if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: Codex generate change message
        run: |
          npm install -g @openai/codex
          export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
          CODEX_QUIET_MODE=1 CI=1 codex -q -a auto-edit "Generate user facing release notes for the last commit, be brief. Use slack compatible markdown format. Write notes to release_note.md"

      - name: Post to Slack
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          node -e "
            const https = require('https');
            const fs = require('fs');
            const url = process.env.SLACK_WEBHOOK;
            const content = fs.readFileSync('release_note.md', 'utf8');
            const data = JSON.stringify({ content, channel: 'C0912S17B9B' });
            const req = https.request(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Content-Length': data.length }
            }, res => {
              res.on('data', d => process.stdout.write(d));
            });
            req.on('error', error => { console.error(error); process.exit(1); });
            req.write(data);
            req.end();
          "
